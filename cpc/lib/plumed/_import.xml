<?xml version="1.0"?>
<cpc>
    <desc>Support for Gromacs mdrun with the PLUMED library</desc>
    <import name="resource" />
    <import name="meas" />

    <type id="grompp_include_array" base="array" member-type="file" />
    <type id="grompp_include_array_array" base="array" 
           member-type="grompp_include_array" />

    <type id="mdp_file_array" base="array" member-type="file" />
    <type id="conf_array" base="array" member-type="file" />
    <type id="top_array" base="array" member-type="file" />
    <type id="ndx_array" base="array" member-type="file" />
    <type id="plumed_array" base="array" member-type="file" />

    <type id="tpr_array" base="array" member-type="file" />
    <type id="prio_array" base="array" member-type="int" />
    <type id="cmdline_array" base="array" member-type="string" />
    <type id="rsrc_array" base="array" member-type="resource::run_desc" />

    <type id="xtc_array" base="array" member-type="file" />
    <type id="trr_array" base="array" member-type="file" />
    <type id="edr_array" base="array" member-type="file" />
    <type id="log_array" base="array" member-type="file" />
    <type id="COLVAR_array" base="array" member-type="file" />
    <type id="HILLS_array" base="array" member-type="file" />
    <type id="bias_array" base="array" member-type="file" />

    <!-- individual settings -->
    <type id="setting" base="record">
        <desc>An individual grompp mdp setting</desc>
        <field id="name" type="string" />
        <field id="value" type="string" />
    </type>
    <type id="mdp_array" base="array" member-type="setting">
        <desc>An array of grompp mdp settings</desc>
    </type>
    <type id="mdp_array_array" base="array" member-type="mdp_array">
        <desc>An array of arrays of grompp mdp settings</desc>
    </type>


    <!-- plumed mdrun controller function -->
    <function id="mdrun" type="python-extended">
        <desc>Runs a PLUMED MD simulation.</desc>
        <inputs>
            <field type="file" id="tpr">
                <desc>The tpr file generated by grompp</desc>
            </field>
            <field type="file" id="plumed">
                <desc>The plumed.dat input file</desc>
            </field>
            <field type="int" id="priority" opt="true">
                <desc>An optional priority for commands issued</desc>
            </field>
            <field type="string" id="cmdline_options" opt="true">
                <desc>An optional string with command line options for mdrun 
                      to use</desc>
            </field>
            <field type="resource::run_desc" id="resources" opt="true">
                <desc>The run resources for tuning this run.</desc>
            </field>
        </inputs>
        <outputs>
            <field type="file" id="conf">
                <desc>Output configuration (.gro) file</desc>
            </field>
            <field type="file" id="stderr">
                <desc>mdrun's standard error output</desc>
            </field>
            <field type="file" id="stdout">
                <desc>mdrun's standard output output</desc>
            </field>
            <field type="file" id="xtc" optional="1">
                <desc>compressed (xtc) trajectory file</desc>
            </field>
            <field type="file" id="trr" optional="1">
                <desc>full-precision (trr) trajectory file</desc>
            </field>
            <field type="file" id="edr">
                <desc>energy+measurements output file</desc>
            </field>
            <field type="file" id="HILLS" optional="1">
                <desc>plumed output of deposited Gaussians</desc>
            </field>
            <field type="file" id="COLVAR">
                <desc>plumed output of CV coordinates</desc>
            </field>
            <field type="file" id="bias" optional="1">
                <desc>plumed grid file output</desc>
            </field>
        </outputs>
        <controller function="cpc.lib.plumed.mdrun" 
                    import="cpc.lib.plumed" 
                    persistent_dir="true" />
    </function>



    <function id="mdrun_multi" type="python-extended">
        <desc>Runs a set of PLUMED MD simulations. Inputs are spread in the 
              same way as grompp_multi</desc>
        <inputs>
            <field type="tpr_array" id="tpr">
                <desc>The tpr file generated by grompp</desc>
            </field>
            <field type="plumed_array" id="plumed">
                <desc>The tpr file generated by grompp</desc>
            </field>
            <field type="prio_array" id="priority" opt="true">
                <desc>An optional priority for commands issued</desc>
            </field>
            <field type="cmdline_array" id="cmdline_options" opt="true">
                <desc>An optional string with command line options for mdrun
                      to use</desc>
            </field>
            <field type="rsrc_array" id="resources" opt="true">
                <desc>The run resources for tuning these runs.</desc>
            </field>
        </inputs>
        <outputs>
            <field type="conf_array" id="conf">
                <desc>Array of Output configuration (.gro) files</desc>
            </field>
            <field type="xtc_array" id="xtc">
                <desc>Array of compressed (xtc) trajectory files</desc>
            </field>
            <field type="trr_array" id="trr">
                <desc>Array of full-precision (trr) trajectory files</desc>
            </field>
            <field type="edr_array" id="edr">
                <desc>Array of energy+measurements output files</desc>
            </field>
            <field type="COLVAR_array" id="COLVAR">
                <desc>plumed collective variable output files</desc>
            </field>
            <field type="HILLS_array" id="HILLS" optional="1">
                <desc>plumed collective variable output files</desc>
            </field>
            <field type="bias_array" id="bias" optional="1">
                <desc>plumed collective variable output files</desc>
            </field>
        </outputs>
        <controller function="cpc.lib.plumed.mdrun_multi"
                    import="cpc.lib.plumed"
                    log="true" persistent_dir="true"
                    access_outputs="true" />
    </function>

    <function id="grompp_mdrun_multi" type="python-extended">
        <desc>Prepares and runs a set of MD simulations.
              A combination of grompp_multi and mdrun_multi.</desc>
        <inputs>
            <field type="conf_array" id="conf">
                <desc>An array of .gro configuration files</desc>
            </field>
            <field type="mdp_file_array" id="mdp" >
                <desc>An array of .mdp settings files</desc>
            </field>
            <field type="top_array" id="top" >
                <desc>An array of .top topology files</desc>
            </field>
            <field type="ndx_array" id="ndx" opt="true">
                <desc>An array of .ndx index files</desc>
            </field>
            <field type="plumed_array" id="plumed" opt="true">
                <desc>An array of plumed input files</desc>
            </field>
            <field type="mdp_array_array" id="settings" opt="true">
                <desc>An array of arrays of settings</desc>
            </field>
            <field type="grompp_include_array_array" id="include" opt="true">
                <desc>An array of .ndx index files</desc>
            </field>
            <field type="prio_array" id="priority" opt="true">
                <desc>An optional priority for commands issued</desc>
            </field>
            <field type="cmdline_array" id="cmdline_options" opt="true">
                <desc>An optional string with command line options for mdrun
                      to use</desc>
            </field>
            <field type="rsrc_array" id="resources" opt="true">
                <desc>The run resources for tuning these runs.</desc>
            </field>
        </inputs>
        <outputs>
            <field type="tpr_array" id="tpr">
                <desc>Array of run descriptions (tpr files)</desc>
            </field>
            <field type="conf_array" id="conf">
                <desc>Array of Output configuration (.gro) files</desc>
            </field>
            <field type="xtc_array" id="xtc">
                <desc>Array of compressed (xtc) trajectory files</desc>
            </field>
            <field type="trr_array" id="trr">
                <desc>Array of full-precision (trr) trajectory files</desc>
            </field>
            <field type="edr_array" id="edr">
                <desc>Array of energy+measurements output files</desc>
            </field>
            <field type="COLVAR_array" id="COLVAR">
                <desc>plumed collective variable output files</desc>
            </field>
            <field type="HILLS_array" id="HILLS" optional="1">
                <desc>plumed collective variable output files</desc>
            </field>
            <field type="bias_array" id="bias" optional="1">
                <desc>plumed collective variable output files</desc>
            </field>
        </outputs>
        <controller function="cpc.lib.plumed.grompp_mdrun_multi"
                    import="cpc.lib.plumed"
                    log="true" persistent_dir="true"
                    access_outputs="true" />
    </function>

</cpc>
