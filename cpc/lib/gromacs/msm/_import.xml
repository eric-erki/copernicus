<?xml version="1.0"?>
<cpc>
    <import name="gromacs" />

    <type id="conf_array" base="array" member-type="file" />
    <type id="xtc_array" base="array" member-type="file" />
    <type id="lh5_array" base="array" member-type="file" />

    <!-- gromacs msm controller function -->
    <function id="msm" type="external">
        <desc>Markov State Modeling adaptive sampling function. Based on 
              msmbuilder.</desc>
        <inputs>
            <!-- gromacs options -->
            <!--<field type="file" id="conf" />-->
            <field type="file" id="mdp">
                <desc>A gromacs mdp file with simulation settings</desc>
            </field>
            <field type="file" id="top">
                <desc>A gromacs topology file</desc>
            </field>
            <field type="file" id="ndx" opt="true">
                <desc>An optional gromacs index file</desc>
            </field>
            <field type="gromacs::grompp-include-array" id="include" opt="1">
                <desc></desc>
            </field>
            <!-- configurations. Fix this once arrays work -->
            <field type="file" id="conf_0">
                <desc>Starting configuration 0 (a .gro file)</desc>
            </field>
            <field type="file" id="conf_1" opt="true">
                <desc>Starting configuration 1 (a .gro file)</desc>
            </field>
            <field type="file" id="conf_2" opt="true">
                <desc>Starting configuration 2 (a .gro file)</desc>
            </field>
            <field type="file" id="conf_3" opt="true">
                <desc>Starting configuration 3 (a .gro file)</desc>
            </field>
            <field type="file" id="conf_4" opt="true">
                <desc>Starting configuration 4 (a .gro file)</desc>
            </field>
            <field type="file" id="conf_5" opt="true">
                <desc>Starting configuration 5 (a .gro file)</desc>
            </field>
            <field type="file" id="conf_6" opt="true">
                <desc>Starting configuration 6 (a .gro file)</desc>
            </field>
            <field type="file" id="conf_7" opt="true">
                <desc>Starting configuration 7 (a .gro file)</desc>
            </field>
            <field type="file" id="conf_8" opt="true">
                <desc>Starting configuration 8 (a .gro file)</desc>
            </field>
            <field type="file" id="conf_9" opt="true">
                <desc>Starting configuration 9 (a .gro file)</desc>
            </field>

            <!-- number of runs to start per configuration-->
            <!--<field type="int" id="init_start_conf"/>-->
            <!-- -->
            <field type="int" id="num_sim" >
                <desc>number of simulations to start simultaneously</desc>
            </field>
            <!-- what atoms to use in the clustering -->
            <!--<field type="file" id="cluster_atoms"/>-->
            <!--  -->
            <field type="int" id="num_states">
                <desc>number of microstates (should be ~ 1/10th of 
                      the number of configurations in each generation)</desc>
            </field>
            <!--  -->
            <field type="float" id="time_step">
                <desc>timestep in the mdp-file</desc>
            </field>
            <!--  -->
            <field type="int" id="nstep">
                <desc>number of steps in the mdp-file</desc>
            </field>
            <!--  -->
            <field type="int" id="nstxtcout">
                <desc>steps between xtc frame output</desc>
            </field>
            <!-- -->
            <field type="float" id="recluster">
                <desc>when to do re-clustering (in trajectory-ns) </desc>
            </field>
            <!--  -->
            <field type="file" id="reference">
                <desc>reference pdb file for clustering</desc>
            </field>
            <!--  -->
            <field type="string" id="grpname" >
                <desc>group name for extracting the right particles</desc>
            </field>
            <!--<field type="file" id="ndx" optional="1" />-->
        </inputs>

        <outputs>
            <!--<field type="file" id="tpr" />
            <field type="file" id="stdout" />-->
            <field type="file" id="log">
                <desc>Log file</desc>
            </field>
            <field type="file" id="err">
                <desc>Error output file</desc>
            </field>
            <field type="file" id="timescales">
                <desc>Timescales vs. implied timescales plot</desc>
            </field>
            <field type="file" id="maxstate">
                <desc>The maximally populated microstate</desc>
            </field>
            <field type="file" id="msm_stdout">
                <desc>msmbuilder standard output</desc>
            </field>
            <field type="file" id="msm_stderr">
                <desc>msmbuilder standard error</desc>
            </field>
            <field type="file" id="msm_macro_stdout">
                <desc>msmbuilder macrostate assignment standard output</desc>
            </field>
            <field type="file" id="msm_macro_stderr">
                <desc>msmbuilder macrostate assignment standard error</desc>
            </field>
            <field type="file" id="macrostate_conf_0">
                <desc>Macrostate 0</desc>
            </field>
            <field type="file" id="macrostate_conf_1">
                <desc>Macrostate 1</desc>
            </field>
            <field type="file" id="macrostate_conf_2">
                <desc>Macrostate 2</desc>
            </field>
            <field type="file" id="macrostate_conf_3">
                <desc>Macrostate 3</desc>
            </field>
            <field type="file" id="macrostate_conf_4">
                <desc>Macrostate 4</desc>
            </field>
            <field type="file" id="macrostate_conf_5">
                <desc>Macrostate 5</desc>
            </field>
            <field type="file" id="macrostate_conf_6">
                <desc>Macrostate 6</desc>
            </field>
            <field type="file" id="macrostate_conf_7">
                <desc>Macrostate 7</desc>
            </field>
            <field type="file" id="macrostate_conf_8">
                <desc>Macrostate 8</desc>
            </field>
            <field type="file" id="macrostate_conf_9">
                <desc>Macrostate 9</desc>
            </field>
            <field type="file" id="weights">
                <desc>Relative weights of macrostates</desc>
            </field>
            <field type="file" id="transition_counts">
                <desc>Transition count matrix of macrostates</desc>
            </field>
        </outputs>
        <!--<controller function="cpc.lib.gromacs.msm.msm" 
                    import="cpc.lib.gromacs.msm" 
                    persistent_dir="true"/>-->
        <controller executable="msm" persistent_dir="true" />
    </function>

    <function id="xtc_to_lh5" type="python-extended">
        <inputs>
            <field type="file" id="xtc" />
            <field type="file" id="ref" />
            <field type="file" id="tpr" />
            <field type="string" id="grpname" />
            <field type="file" id="ndx" opt="true"/>
        </inputs>
        <outputs>
            <!-- the no-pbc xtc: -->
            <field type="file" id="xtc" /> 
            <field type="file" id="xtc_orig" /> 
            <field type="file" id="lh5" />
        </outputs>
        <controller function="cpc.lib.gromacs.msm.tolh5" 
                    import="cpc.lib.gromacs.msm"  
                    persistent_dir="true" />
    </function>
</cpc>

