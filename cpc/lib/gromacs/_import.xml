<?xml version="1.0"?>
<cpc>
    <desc>Gromacs specific functions</desc>
    <import name="resource" />

    <type id="grompp-include-array" base="array" member-type="file" />

    <type id="out-grompp-multi" base="record">
        <desc>tpr file</desc>
        <field type="file" id="tpr">
            <desc>generated tpr file</desc>
        </field>
        <field type="file" id="stdout">
            <desc>log file </desc>
        </field>
    </type>


    <type id="out-mdrun-multi" base="record">
        <field type="file" id="conf">
            <desc>Output configuration (.gro) file</desc>
        </field>
        <field type="file" id="stderr">
            <desc>mdrun's standard error output</desc>
        </field>
        <field type="file" id="stdout">
            <desc>mdrun's standard output output</desc>
        </field>
        <field type="file" id="xtc" optional="1">
            <desc>compressed (xtc) trajectory file</desc>
        </field>
        <field type="file" id="trr" optional="1">
            <desc>full-precision (trr) trajectory file</desc>
        </field>
        <field type="file" id="edr">
            <desc>energy+measurements output file</desc>
        </field>
    </type>

    <type id="mdp-file-array" base="array" member-type="file" />
    <type id="conf-array" base="array" member-type="file" />
    <type id="top-array" base="array" member-type="file" />
    <type id="ndx-array" base="array" member-type="file" />
    <type id="out-grompp-multi-array" base="array" member-type="out-grompp-multi" />
    <type id="out-mdrun-multi-array" base="array" member-type="out-mdrun-multi" />

    <type id="tpr-array" base="array" member-type="file" />
    <type id="prio-array" base="array" member-type="int" />
    <type id="cmdline-array" base="array" member-type="string" />

    <!-- individual settings -->
    <type id="setting" base="record">
        <desc>An individual grompp mdp setting</desc>
        <field id="name" type="string" />
        <field id="value" type="string" />
    </type>
    <type id="mdp-array" base="array" member-type="setting">
        <desc>An array of grompp mdp settings</desc>
    </type>



    <function id="grompp_multi" type="python-extended">
        <desc>can handle multiple input files</desc>
        <inputs>
            <field type="conf-array" id="conf">
                <desc>An array of .gro configuration files</desc>
            </field>
            <field type="mdp-file-array" id="mdp" >
                <desc>An array of .mdp settings files</desc>
            </field>
            <field type="top-array" id="top" >
                <desc>An array of .top topology files</desc>
            </field>
            <field type="ndx-array" id="ndx" opt="true">
                <desc>An array of .ndx index files</desc>
            </field>
        </inputs>
        <outputs>
            <field type="tpr-array" id="result">
            <desc>the tpr file for mdrun</desc>
            </field>
            <!--<field type="out-grompp-multi-array" id="result">-->
                <!--<desc>the tpr file for mdrun and stdout out generated during grompp</desc>-->
            <!--</field>-->
        </outputs>
        <controller function="cpc.lib.gromacs.grompp_multi"
                    import="cpc.lib.gromacs"
                    log="true" persistent_dir="true"
                    access_outputs="true"
                />
    </function>


    <!-- gromacs mdrun controller function -->
    <function id="mdrun_multi" type="python-extended">
        <desc>Runs an MD simulation.</desc>
        <inputs>
            <field type="tpr-array" id="tpr">
                <desc>The tpr file generated by grompp</desc>
            </field>
            <field type="prio-array" id="priority" opt="true">
                <desc>An optional priority for commands issued</desc>
            </field>
            <field type="cmdline-array" id="cmdline_options" opt="true">
                <desc>An optional string with command line options for mdrun
                    to use</desc>
            </field>
        </inputs>
        <outputs>
            <field type="out-mdrun-multi-array" id="result">
                <desc>simulation results</desc>
            </field>
        </outputs>
        <controller function="cpc.lib.gromacs.mdrun_multi"
                    import="cpc.lib.gromacs"
                    log="true" persistent_dir="true"
                    access_outputs="true" />
    </function>



    <function id="grompp" type="python-extended">
        <desc>The gromacs pre-processor: prepares run files for mdrun</desc>
        <inputs>
            <field type="file" id="conf">
                <desc>A .gro configuration file</desc>
            </field>
            <field type="file" id="mdp" >
                <desc>A .mdp settings file</desc>
            </field>
            <field type="file" id="top" >
                <desc>A .top topology file</desc>
            </field>
            <field type="grompp-include-array" id="include" opt="true">
                <desc>array of files to include</desc>
            </field>
            <field type="mdp-array" id="settings" opt="true">
                <desc>array of settings</desc>
            </field>
            <field type="file" id="ndx" opt="true">
                <desc>An .ndx index file</desc>
            </field>
        </inputs>
        <outputs>
            <field type="file" id="tpr">
                <desc>the tpr file for mdrun</desc>
            </field>
            <field type="file" id="stdout">
                <desc>stdout generated during grompp run</desc>
            </field>
        </outputs>
        <controller function="cpc.lib.gromacs.grompp" 
                    import="cpc.lib.gromacs" />
    </function>

    <!-- gromacs mdrun controller function -->
    <function id="mdrun" type="python-extended">
        <desc>Runs an MD simulation.</desc>
        <inputs>
            <field type="file" id="tpr">
                <desc>The tpr file generated by grompp</desc>
            </field>
            <field type="int" id="priority" opt="true">
                <desc>An optional priority for commands issued</desc>
            </field>
            <field type="string" id="cmdline_options" opt="true">
                <desc>An optional string with command line options for mdrun 
                      to use</desc>
            </field>
            <field type="resource::run_desc" id="resources" opt="true">
                <desc>The run resources for tuning this run.</desc>
            </field>
        </inputs>
        <outputs>
            <field type="file" id="conf">
                <desc>Output configuration (.gro) file</desc>
            </field>
            <field type="file" id="stderr">
                <desc>mdrun's standard error output</desc>
            </field>
            <field type="file" id="stdout">
                <desc>mdrun's standard output output</desc>
            </field>
            <field type="file" id="xtc" optional="1">
                <desc>compressed (xtc) trajectory file</desc>
            </field>
            <field type="file" id="trr" optional="1">
                <desc>full-precision (trr) trajectory file</desc>
            </field>
            <field type="file" id="edr">
                <desc>energy+measurements output file</desc>
            </field>
        </outputs>
        <controller function="cpc.lib.gromacs.mdrun" 
                    import="cpc.lib.gromacs" 
                    persistent_dir="true" />
    </function>

    <function id="mdrun_tune" type="python-extended">
        <desc>Optimize an MD simulation (for the available run resources).</desc>
        <inputs>
            <field type="file" id="conf">
                <desc>A .gro configuration file</desc>
            </field>
            <field type="file" id="mdp" >
                <desc>A .mdp settings file</desc>
            </field>
            <field type="file" id="top" >
                <desc>A .top topology file</desc>
            </field>
            <field type="grompp-include-array" id="include" opt="true">
                <desc>array of files to include</desc>
            </field>
            <field type="mdp-array" id="settings" opt="true">
                <desc>array of settings</desc>
            </field>
            <field type="file" id="ndx" opt="true">
                <desc>An .ndx index file</desc>
            </field>
            <field type="string" id="cmdline_options" opt="true">
                <desc>An optional string with command line options for mdrun 
                      to use</desc>
            </field>
        </inputs>
        <outputs>
            <field type="file" id="mdp" >
                <desc>A processed .mdp settings file</desc>
            </field>
            <field type="resource::run_desc" id="resources">
                <desc>The run resources for this run.</desc>
            </field>
        </outputs>
        <controller function="cpc.lib.gromacs.tune_fn" 
                    import="cpc.lib.gromacs" 
                    persistent_dir="true" />
    </function>

    <function id="g_energy" type="python-extended">
        <desc>Extracts energy + other global averages from an .edr file.</desc>
        <inputs>
            <field type="file" id="edr">
                <desc>The edr file generated by mdrun</desc>
            </field>
            <field type="string" id="item">
                <desc>The item name to extract. Valid choices include: Potential, Kinetic, Total-Energy, Temperature, Pressure, Pres-XX - Pres-ZZ, Vir-XX - Vir-ZZ, Volume</desc>
            </field>
        </inputs>
        <outputs>
            <field type="file" id="xvg">
                <desc>Output plot</desc>
            </field>
            <field type="float" id="average">
                <desc>The extracted item's average</desc>
            </field>
            <field type="float" id="error">
                <desc>The extracted item's error estimate around the average.</desc>
            </field>
            <field type="float" id="drift">
                <desc>The extracted item's total drift.</desc>
            </field>
            <field type="float" id="rmsd">
                <desc>The extracted item's root mean square deviation.</desc>
            </field>
            <field type="string" id="unit">
                <desc>The extracted item's units in a string.</desc>
            </field>
        </outputs>
        <controller function="cpc.lib.gromacs.g_energy" 
                    import="cpc.lib.gromacs" 
                    persistent_dir="true" />
    </function>

    <function id="trjconv" type="python-extended">
        <desc>Converts and processes trajectories.</desc>
        <inputs>
            <field type="file" id="tpr">
                <desc>The run input file.</desc>
            </field>
            <field type="file" id="trj">
                <desc>Trajectory file (trr,xtc,pdb,etc.).</desc>
            </field>
            <field type="cmdline-array" id="cmdline_options" opt="true">
                <desc>An optional string with command line options for mdrun
                    to use</desc>
            </field>
            <field type="string" id="output_groups" opt="true">
                <desc>Which group index to output, select for operations, etc.</desc>
            </field>
            <field type="file" id="ndx" opt="true">
                <desc>An .ndx index file</desc>
            </field>
        </inputs>
        <outputs>
            <field type="file" id="xtc">
                <desc>Output trajectory</desc>
            </field>
        </outputs>
        <controller function="cpc.lib.gromacs.trjconv" 
                    import="cpc.lib.gromacs" 
                    persistent_dir="true" />
    </function>

    <function id="pdb2gmx" type="python-extended">
        <desc>Creates processed gro and topology from pdb.</desc>
        <inputs>
            <field type="file" id="conf">
                <desc>The input structure.</desc>
            </field>
            <field type="string" id="ff">
                <desc>Force field to use.</desc>
            </field>
            <field type="string" id="water">
                <desc>Water model to use.</desc>
            </field>
            <field type="cmdline-array" id="cmdline_options" opt="true">
                <desc>An optional string with command line options for mdrun
                    to use</desc>
            </field>
            <field type="string" id="input_choices" opt="true">
                <desc>Stdin for any manual choices.</desc>
            </field>
        </inputs>
        <outputs>
            <field type="file" id="conf">
                <desc>Processed structure</desc>
            </field>
            <field type="file" id="top">
                <desc>Topology</desc>
            </field>
            <field type="grompp-include-array" id="include">
                <desc>array of .itp files created.</desc>
            </field>
        </outputs>
        <controller function="cpc.lib.gromacs.pdb2gmx" 
                    import="cpc.lib.gromacs" 
                    persistent_dir="true" />
    </function>

</cpc>
